<!DOCTYPE html>

<head>
  <title>whatever</title>
  <style>
    .word, .player {
      display: inline;
      padding-right: 1em;
    }
    .active-player {
      color: red;
    }
  </style>
</head>

<body>

  <p id="story"></p>
  <div id="words"></div>
  <div id="players"></div>
  <p id="countdown"></p>

  <script type="text/javascript">

    let id;
    let turn;
    let players = [];
    let timers = [];

    let ws = new WebSocket('ws://localhost:8080/status');
    ws.onerror = e => console.log(e);
    ws.onopen = () => console.log('open');
    ws.onclose = () => console.log('close');
    ws.onmessage = e => {

      const msg = JSON.parse(e.data);
      console.log(msg);

      if (msg.id !== undefined) {
        id = msg.id;
      }

      if (msg.words !== undefined) {
        let wordsDiv = document.getElementById('words');
        // Wipe its children.
        while (wordsDiv.firstChild) wordsDiv.removeChild(wordsDiv.firstChild);
        // Append each of the words.
        msg.words.forEach(word => {
          let node = document.createElement('DIV');
          let text = document.createTextNode(word.word);
          node.appendChild(text);
          node.onclick = () => ws.send(JSON.stringify({ id: word.id }));
          node.className = 'word';
          wordsDiv.appendChild(node);
        });
      }

      if (msg.story !== undefined) {
        document.getElementById('story').innerHTML = msg.story;
      }

      if (msg.turn !== undefined) {
        turn = msg.turn;
        // Clear existing timers.
        timers.forEach(x => clearTimeout(x));
        // Generate timers for the countdown.
        let zero_to_nine = [...Array(10).keys()];
        timers = zero_to_nine.map(x => {
          return setTimeout(() => {
            document.getElementById('countdown').innerHTML = `${10-x}`
          }, x*1000);
        });
        updatePlayersHTML(players, turn);
      }

      if (msg.players !== undefined) {
        players = msg.players;
        updatePlayersHTML(players, turn);
      }

      function updatePlayersHTML(players, turn) {
        let playersDiv = document.getElementById('players');
        // Wipe its children.
        while (playersDiv.firstChild) playersDiv.removeChild(playersDiv.firstChild);
        // Append each of the words.
        players.forEach(player => {
          let node = document.createElement('DIV');
          let text = document.createTextNode(`Player ${player.id}${player.id == id ? ' (You)' : ''}`);
          node.appendChild(text);
          node.className = 'player';
          if (player.id == turn) node.className += ' active-player';
          playersDiv.appendChild(node);
        });
      }

    }

  </script>

</body>