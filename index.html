<!DOCTYPE html>

<head>
  <title>whatever</title>
  <style>
    .word {
      display: inline;
      padding: 2em;
      margin: 1em;
    }
  </style>
</head>

<body>

  <p id="story"></p>

  <div id="words"></div>

  <p id="turn"></p>

  <script type="text/javascript">

    let id;
    let timers = [];

    let ws = new WebSocket('ws://localhost:8080/status');
    ws.onerror = e => console.log(e);
    ws.onopen = () => console.log('open');
    ws.onclose = () => console.log('close');
    ws.onmessage = e => {

      const msg = JSON.parse(e.data);
      console.log(msg);

      if (msg.id !== undefined) {
        id = msg.id;
      }

      if (msg.words !== undefined) {
        let wordsDiv = document.getElementById('words');
        // Wipe its children.
        while (wordsDiv.firstChild) wordsDiv.removeChild(wordsDiv.firstChild);
        // Append each of the words.
        msg.words.forEach(word => {
          let node = document.createElement('DIV');
          let text = document.createTextNode(word.word);
          node.appendChild(text);
          node.onclick = () => ws.send(JSON.stringify({ id: word.id }));
          node.className = 'word';
          wordsDiv.appendChild(node);
        });
      }

      if (msg.story !== undefined) {
        document.getElementById('story').innerHTML = msg.story;
      }

      if (msg.turn !== undefined) {
        // Clear existing timers.
        timers.forEach(x => clearTimeout(x));
        if (msg.turn == id) {
          // Generate timers for the countdown.
          let zero_to_nine = [...Array(10).keys()];
          timers = zero_to_nine.map(x => {
            return setTimeout(() => {
              document.getElementById('turn').innerHTML = `Your Turn! ${10-x}`
            }, x*1000);
          });
        } else {
          document.getElementById('turn').innerHTML = `Player ${msg.turn}'s Turn`;
        }
      }

    }

  </script>

</body>